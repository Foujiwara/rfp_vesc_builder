name: VESC Firmware Build & Archive

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repo
        uses: actions/checkout@v4

      - name: Clone official VESC firmware
        run: |
          git clone --depth 1 --branch release_6_06 https://github.com/vedderb/bldc.git bldc

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            git \
            make \
            wget \
            libgl-dev \
            libxcb-xinerama0

      - name: Install VESC ARM SDK
        run: |
          cd bldc
          make arm_sdk_install

      - name: Inject custom hwconf
        run: |
          cp custom_hwconf/* bldc/hwconf/

      - name: Build firmware (C350ref)
        run: |
          cd bldc
          make fw_C350ref

      - name: Prepare archive content
        run: |
          mkdir -p archive/release_6_06/C350ref
          cp bldc/build/C350ref/C350ref.bin \
             archive/release_6_06/C350ref/C350ref_release_6_06.bin

      - name: Push to firmware archive repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: Foujiwara/rfp_fw_archive
          publish_branch: main
          publish_dir: ./archive
          personal_token: ${{ secrets.ARCHIVE_TOKEN }}
