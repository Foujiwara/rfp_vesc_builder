name: VESC Firmware Builder – Multi HW Archive

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repo
        uses: actions/checkout@v4

      - name: Load builder configuration
        run: |
          if [ ! -f builder.conf ]; then
            echo "ERROR: builder.conf not found"
            exit 1
          fi
          cat builder.conf

      - name: Clone official VESC firmware
        run: |
          source builder.conf
          git clone --depth 1 --branch "$TAG" https://github.com/vedderb/bldc.git bldc


      - name: Build firmware (single / all + no limits)
        run: |
          set -e

          cd bldc

          # ==============================
          # Détermination des HW à builder
          # ==============================
          if [ "$BUILD_MODE" = "single" ]; then
            HW_LIST="$SINGLE_MODEL"
          else
            HW_LIST=$(ls hwconf | grep '^hw_.*\.h$' | sed 's/^hw_//' | sed 's/\.h$//')
          fi

          echo "HW to build:"
          echo "$HW_LIST"

          mkdir -p ../archive

          for HW in $HW_LIST; do
            echo "=============================="
            echo "Building $HW"
            echo "=============================="

            make clean
            make fw_$HW

            BIN_PATH="build/$HW/$HW.bin"

            # ==============================
            # Nom firmware normal
            # ==============================
            NAME="$HW"
            [ "$PREFIX_RFP" = "yes" ] && NAME="RFP_${NAME}"
            NAME="${NAME}_${UPSTREAM_TAG}"

            cp "$BIN_PATH" "../archive/${NAME}.bin"

            # ==============================
            # NO LIMITS (optionnel)
            # ==============================
            if [ "$BUILD_NO_LIMITS" = "yes" ]; then
              echo "Generating NO LIMITS for $HW"

              mkdir -p build_hwconf

              cat > build_hwconf/${HW}_no_limits.h <<EOF
              
          #ifndef HW_${HW}_NO_LIMITS_H
          #define HW_${HW}_NO_LIMITS_H

          #define DISABLE_HW_LIMITS
          #include "hw_${HW}.h"

          #endif
          EOF

              make clean
              make fw_custom \
                HW_HEADER="build_hwconf/${HW}_no_limits.h" \
                HW_SRC="hwconf/hw_${HW}.c"

              NO_LIMITS_BIN="build/custom/custom.bin"

              NL_NAME="$HW"
              [ "$PREFIX_RFP" = "yes" ] && NL_NAME="RFP_${NL_NAME}"
              NL_NAME="${NL_NAME}_${UPSTREAM_TAG}_NO_LIMITS"

              cp "$NO_LIMITS_BIN" "../archive/${NL_NAME}.bin"
            fi
          done

    






      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            git \
            make \
            wget \
            libgl-dev \
            libxcb-xinerama0

      - name: Install VESC ARM SDK (official)
        run: |
          cd bldc
          make arm_sdk_install

      - name: Inject all custom hwconf
        run: |
          find custom_hwconf -type f \( -name "hw_*.c" -o -name "hw_*.h" \) \
            -exec cp {} bldc/hwconf/ \;

      - name: Build firmware (config driven)
        run: |
          set -e
          source builder.conf

          # Extract version from tag: release_6_06 → 6.06
          VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')

          mkdir -p archive/$TAG

          build_one() {
            MODEL_TECH="$1"
            BRAND_DIR="$2"
            MODEL_DIR="$3"
            VARIANT="$4"   # "" or "_no_limits"

            TARGET="fw_${MODEL_TECH}${VARIANT}"

            NAME_PREFIX=""
            [ "$PREFIX_RFP" = "yes" ] && NAME_PREFIX="RFP_"

            VARIANT_NAME=""
            [ -n "$VARIANT" ] && VARIANT_NAME="_NO_LIMITS"

            FINAL_NAME="${NAME_PREFIX}${MODEL_TECH}${VARIANT_NAME}_${VERSION}"

            echo "------------------------------"
            echo "Building $TARGET → $FINAL_NAME"
            echo "------------------------------"

            # Patch HW_NAME dynamically
            HFILE="bldc/hwconf/hw_${MODEL_TECH}.h"
            if [ -f "$HFILE" ]; then
              sed -i "s|#define HW_NAME.*|#define HW_NAME \"${FINAL_NAME}\"|g" "$HFILE"
            fi

            cd bldc
            if make -n "$TARGET" >/dev/null 2>&1; then
              make "$TARGET"
            else
              echo "Target $TARGET does not exist, skipping."
              cd ..
              return
            fi
            cd ..

            mkdir -p "archive/$TAG/$BRAND_DIR/$MODEL_DIR"

            cp "bldc/build/${MODEL_TECH}${VARIANT}/${MODEL_TECH}${VARIANT}.bin" \
               "archive/$TAG/$BRAND_DIR/$MODEL_DIR/${FINAL_NAME}.bin"
          }

          if [ "$BUILD_MODE" = "single" ]; then
            hwfile=$(find custom_hwconf -name "hw_${SINGLE_MODEL}.h" | head -n1)
            [ -z "$hwfile" ] && echo "ERROR: hw_${SINGLE_MODEL}.h not found" && exit 1

            MODEL_DIR=$(basename "$(dirname "$hwfile")")
            BRAND_DIR=$(basename "$(dirname "$(dirname "$hwfile")")")

            build_one "$SINGLE_MODEL" "$BRAND_DIR" "$MODEL_DIR" ""

            [ "$BUILD_NO_LIMITS" = "yes" ] && \
              build_one "$SINGLE_MODEL" "$BRAND_DIR" "$MODEL_DIR" "_no_limits"

          else
            find custom_hwconf -name "hw_*.h" | while read hwfile; do
              MODEL_TECH=$(basename "$hwfile" .h)
              MODEL_TECH=${MODEL_TECH#hw_}

              MODEL_DIR=$(basename "$(dirname "$hwfile")")
              BRAND_DIR=$(basename "$(dirname "$(dirname "$hwfile")")")

              build_one "$MODEL_TECH" "$BRAND_DIR" "$MODEL_DIR" ""

              [ "$BUILD_NO_LIMITS" = "yes" ] && \
                build_one "$MODEL_TECH" "$BRAND_DIR" "$MODEL_DIR" "_no_limits"
            done
          fi     

      - name: Ensure no .nojekyll
        run: |
          rm -f archive/.nojekyll

      - name: Push to firmware archive repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: Foujiwara/rfp_fw_archive
          publish_branch: main
          publish_dir: ./archive
          personal_token: ${{ secrets.ARCHIVE_TOKEN }}
          enable_jekyll: false
