      - name: Resolve upstream version (FIXED)
        run: |
          set -e
          source builder.conf

          echo "UPSTREAM_MODE='$UPSTREAM_MODE'"

          if [ -z "$UPSTREAM_MODE" ]; then
            echo "ERROR: UPSTREAM_MODE is EMPTY"
            exit 1
          fi

          if [ "$UPSTREAM_MODE" = "latest" ]; then
            TAG=$(git ls-remote --heads https://github.com/vedderb/bldc.git \
              | grep 'refs/heads/release_' \
              | sed 's|.*refs/heads/||' \
              | sort -V \
              | tail -n1)

            if [ -z "$TAG" ]; then
              echo "ERROR: No release_* branch found upstream"
              exit 1
            fi

            VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
            BETA="no"

          elif [ "$UPSTREAM_MODE" = "master" ]; then
            TAG="master"
            VERSION="MASTER"
            BETA="yes"

          elif [[ "$UPSTREAM_MODE" == release_* ]]; then
            TAG="$UPSTREAM_MODE"
            VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
            BETA="no"

          else
            echo "ERROR: Invalid UPSTREAM_MODE='$UPSTREAM_MODE'"
            exit 1
          fi

          echo "Resolved upstream:"
          echo "TAG=$TAG"
          echo "VERSION=$VERSION"
          echo "BETA=$BETA"

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BETA=$BETA" >> $GITHUB_ENV
