name: RFP VESC Firmware Builder

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repo
        uses: actions/checkout@v4

      # ======================================================
      # LOAD CONFIG (SOURCE OF TRUTH)
      # ======================================================
      - name: Load builder configuration
        run: |
          set -e

          if [ ! -f builder.conf ]; then
            echo "ERROR: builder.conf not found"
            exit 1
          fi

          source builder.conf

          echo "CONFIG:"
          echo "UPSTREAM_MODE=$UPSTREAM_MODE"
          echo "BUILD_MODE=$BUILD_MODE"
          echo "SINGLE_MODEL=$SINGLE_MODEL"
          echo "BUILD_NO_LIMITS=$BUILD_NO_LIMITS"
          echo "PREFIX_RFP=$PREFIX_RFP"

          echo "UPSTREAM_MODE=$UPSTREAM_MODE" >> $GITHUB_ENV
          echo "BUILD_MODE=$BUILD_MODE" >> $GITHUB_ENV
          echo "SINGLE_MODEL=$SINGLE_MODEL" >> $GITHUB_ENV
          echo "BUILD_NO_LIMITS=$BUILD_NO_LIMITS" >> $GITHUB_ENV
          echo "PREFIX_RFP=$PREFIX_RFP" >> $GITHUB_ENV

      # ======================================================
      # RESOLVE UPSTREAM (RELEASE BRANCHES, NOT TAGS)
      # ======================================================
      - name: Resolve upstream
        run: |
          set -e

          case "$UPSTREAM_MODE" in
            latest)
              TAG=$(git ls-remote --heads https://github.com/vedderb/bldc.git \
                | grep 'refs/heads/release_' \
                | sed 's|.*refs/heads/||' \
                | sort -V \
                | tail -n1)

              if [ -z "$TAG" ]; then
                echo "ERROR: no release branch found"
                exit 1
              fi

              VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
              IS_BETA="no"
              ;;

            master)
              TAG="master"
              VERSION="master"
              IS_BETA="yes"
              ;;

            release_*)
              TAG="$UPSTREAM_MODE"
              VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
              IS_BETA="no"
              ;;

            *)
              echo "ERROR: invalid UPSTREAM_MODE=$UPSTREAM_MODE"
              exit 1
              ;;
          esac

          echo "Resolved upstream:"
          echo "TAG=$TAG"
          echo "VERSION=$VERSION"
          echo "IS_BETA=$IS_BETA"

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "IS_BETA=$IS_BETA" >> $GITHUB_ENV

      # ======================================================
      # OFFICIAL VESC BUILD FLOW (UNCHANGED)
      # ======================================================
      - name: Clone VESC firmware
        run: |
          git clone --depth 1 --branch "$TAG" https://github.com/vedderb/bldc.git bldc

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential git wget libgl-dev libxcb-xinerama0

      - name: Install ARM SDK (official)
        run: |
          cd bldc
          make arm_sdk_install

      # ======================================================
      # BUILD
      # ======================================================
      - name: Build firmware(s)
        run: |
          set -e
          cd bldc

          mkdir -p ../output

          build_one() {
            HW="$1"

            echo "=============================="
            echo "Building $HW"
            echo "=============================="

            make fw_$HW

            NAME="${HW}_${VERSION}"

            if [ "$PREFIX_RFP" = "yes" ]; then
              NAME="RFP_${NAME}"
            fi

            if [ "$IS_BETA" = "yes" ]; then
              NAME="${NAME}_BETA"
            fi

            mkdir -p ../output/$HW
            cp build/$HW/$HW.bin ../output/$HW/${NAME}.bin
          }

          if [ "$BUILD_MODE" = "single" ]; then
            build_one "$SINGLE_MODEL"

            if [ "$BUILD_NO_LIMITS" = "yes" ]; then
              build_one "${SINGLE_MODEL}_no_limits"
            fi

          elif [ "$BUILD_MODE" = "all" ]; then
            for HW in $(make -s | grep '^fw_' | sed 's/fw_//'); do
              build_one "$HW"
            done

          else
            echo "ERROR: invalid BUILD_MODE=$BUILD_MODE"
            exit 1
          fi

      # ======================================================
      # ARCHIVE EXPORT (NON-DESTRUCTIVE)
      # ======================================================
      - name: Push firmware to archive
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: Foujiwara/rfp_fw_archive
          publish_branch: main
          publish_dir: ./output
          personal_token: ${{ secrets.ARCHIVE_TOKEN }}
          keep_files: true
