name: RFP VESC Builder (Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repo
        uses: actions/checkout@v4

      # ===============================
      # USER OPTIONS (SAFE)
      # ===============================
      - name: Resolve upstream (NO BUILD CHANGE)
        run: |
          set -e

          # -------- USER CHOICE ----------
          UPSTREAM_MODE="latest"
          HW_NAME="C350ref"
          PREFIX_RFP="yes"
          # -------------------------------

          echo "UPSTREAM_MODE=$UPSTREAM_MODE"

          if [ "$UPSTREAM_MODE" = "latest" ]; then
            TAG=$(git ls-remote --heads https://github.com/vedderb/bldc.git \
              | grep 'refs/heads/release_' \
              | sed 's|.*refs/heads/||' \
              | sort -V \
              | tail -n1)

            VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
            IS_BETA="no"

          elif [ "$UPSTREAM_MODE" = "master" ]; then
            TAG="master"
            VERSION="master"
            IS_BETA="yes"

          elif [[ "$UPSTREAM_MODE" == release_* ]]; then
            TAG="$UPSTREAM_MODE"
            VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
            IS_BETA="no"

          else
            echo "ERROR: invalid UPSTREAM_MODE"
            exit 1
          fi

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "IS_BETA=$IS_BETA" >> $GITHUB_ENV
          echo "HW_NAME=$HW_NAME" >> $GITHUB_ENV
          echo "PREFIX_RFP=$PREFIX_RFP" >> $GITHUB_ENV

          echo "Resolved:"
          echo "TAG=$TAG"
          echo "VERSION=$VERSION"
          echo "BETA=$IS_BETA"

      # ===============================
      # OFFICIAL VESC FLOW (UNCHANGED)
      # ===============================
      - name: Clone VESC firmware
        run: |
          git clone --depth 1 --branch "$TAG" https://github.com/vedderb/bldc.git bldc

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential git wget libgl-dev libxcb-xinerama0

      - name: Install ARM SDK (official Makefile)
        run: |
          cd bldc
          make arm_sdk_install

      - name: Inject custom HW config
        run: |
          cp custom_hwconf/$HW_NAME/* bldc/hwconf/

      - name: Build firmware (OFFICIAL TARGET)
        run: |
          cd bldc
          make fw_$HW_NAME

      # ===============================
      # EXPORT (NON-DESTRUCTIVE)
      # ===============================
      - name: Export firmware
        run: |
          mkdir -p output/$HW_NAME

          if [ "$PREFIX_RFP" = "yes" ]; then
            OUT_NAME="RFP_${HW_NAME}_${VERSION}"
          else
            OUT_NAME="${HW_NAME}_${VERSION}"
          fi

          if [ "$IS_BETA" = "yes" ]; then
            OUT_NAME="${OUT_NAME}_BETA"
          fi

          cp bldc/build/$HW_NAME/$HW_NAME.bin \
             output/$HW_NAME/${OUT_NAME}.bin

          echo "Exported: ${OUT_NAME}.bin"

      - name: Push to archive (NO DELETE)
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: Foujiwara/rfp_fw_archive
          publish_branch: main
          publish_dir: ./output
          personal_token: ${{ secrets.ARCHIVE_TOKEN }}
          keep_files: true
