name: Build VESC Firmware (Official Method)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      # 1️⃣ Checkout builder (pour hwconf custom)
      - name: Checkout builder repo
        uses: actions/checkout@v3

      # 2️⃣ Clone firmware officiel (release FIXE)
      - name: Clone official VESC firmware
        run: |
          git clone --branch release_6_06 https://github.com/vedderb/bldc.git bldc

      # 3️⃣ Inject custom hwconf
      - name: Inject custom hwconf
        run: |
          cp custom_hwconf/* bldc/hwconf/

      # 4️⃣ Install EXACT dependencies (comme recommandé par le projet)
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            build-essential \
            gcc-arm-none-eabi \
            libgl-dev \
            libxcb-xinerama0 \
            wget

      # 5️⃣ Build firmware EXACTEMENT comme le projet
      - name: Build firmware (fw_all)
        run: |
          cd bldc
          make fw_all

      # 6️⃣ Collect binaries
      - name: Collect firmware
        run: |
          mkdir -p output
          find bldc/build -name "*.bin" -exec cp {} output/ \;
