name: VESC Firmware Builder – Multi HW Archive (SAFE)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repo
        uses: actions/checkout@v4

      - name: Clone official VESC firmware
        run: |
          git clone --depth 1 --branch release_6_06 https://github.com/vedderb/bldc.git bldc

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            git \
            make \
            wget \
            libgl-dev \
            libxcb-xinerama0

      - name: Install VESC ARM SDK (official)
        run: |
          cd bldc
          make arm_sdk_install

      # Injection de tous les hwconf
      - name: Inject custom hwconf
        run: |
          find custom_hwconf -type f \( -name "hw_*.c" -o -name "hw_*.h" \) \
            -exec cp {} bldc/hwconf/ \;

      # Build sécurisé basé sur hw_*.h
      - name: Build all custom HW (no clean, no spaces)
        run: |
          set -e
          VERSION="V6.06"
          TAG="release_6_06"

          mkdir -p archive/$TAG

          find custom_hwconf -name "hw_*.h" | while read hwfile; do
            MODEL=$(basename "$hwfile" .h)
            MODEL=${MODEL#hw_}

            BRAND=$(basename "$(dirname "$(dirname "$hwfile")")")

            echo "=============================="
            echo "Building $BRAND / $MODEL"
            echo "=============================="

            cd bldc
            make fw_$MODEL
            cd ..

            mkdir -p archive/$TAG/$BRAND/$MODEL

            cp bldc/build/$MODEL/$MODEL.bin \
               archive/$TAG/$BRAND/$MODEL/${MODEL}_${VERSION}_RFP.bin
          done

      - name: Ensure no .nojekyll
        run: |
          rm -f archive/.nojekyll

      - name: Push to firmware archive repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: Foujiwara/rfp_fw_archive
          publish_branch: main
          publish_dir: ./archive
          personal_token: ${{ secrets.ARCHIVE_TOKEN }}
          enable_jekyll: false
