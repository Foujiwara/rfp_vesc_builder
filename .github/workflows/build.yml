name: RFP VESC Firmware Builder

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repo
        uses: actions/checkout@v4

      # ======================================================
      # LOAD CONFIG (SOURCE OF TRUTH)
      # ======================================================
      - name: Load builder configuration
        run: |
          set -e
          source builder.conf

          for v in UPSTREAM_MODE BUILD_MODE SINGLE_MODEL HW_TARGET BUILD_NO_LIMITS PREFIX_RFP; do
            if [ -z "${!v}" ]; then
              echo "ERROR: $v is not defined in builder.conf"
              exit 1
            fi
          done

          echo "UPSTREAM_MODE=$UPSTREAM_MODE" >> $GITHUB_ENV
          echo "BUILD_MODE=$BUILD_MODE" >> $GITHUB_ENV
          echo "SINGLE_MODEL=$SINGLE_MODEL" >> $GITHUB_ENV
          echo "HW_TARGET=$HW_TARGET" >> $GITHUB_ENV
          echo "BUILD_NO_LIMITS=$BUILD_NO_LIMITS" >> $GITHUB_ENV
          echo "PREFIX_RFP=$PREFIX_RFP" >> $GITHUB_ENV

      # ======================================================
      # RESOLVE UPSTREAM (RELEASE BRANCHES)
      # ======================================================
      - name: Resolve upstream
        run: |
          set -e

          case "$UPSTREAM_MODE" in
            latest)
              TAG=$(git ls-remote --heads https://github.com/vedderb/bldc.git \
                | grep 'refs/heads/release_' \
                | sed 's|.*refs/heads/||' \
                | sort -V \
                | tail -n1)
              VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
              IS_BETA="no"
              ;;
            master)
              TAG="master"
              VERSION="master"
              IS_BETA="yes"
              ;;
            release_*)
              TAG="$UPSTREAM_MODE"
              VERSION=$(echo "$TAG" | sed 's/release_//' | sed 's/_/./g')
              IS_BETA="no"
              ;;
            *)
              echo "ERROR: invalid UPSTREAM_MODE"
              exit 1
              ;;
          esac

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "IS_BETA=$IS_BETA" >> $GITHUB_ENV

      # ======================================================
      # CLONE UPSTREAM (PURE)
      # ======================================================
      - name: Clone VESC firmware
        run: |
          git clone --depth 1 --branch "$TAG" https://github.com/vedderb/bldc.git bldc

      # ======================================================
      # INJECT CUSTOM HW CONFIG (RFP)
      # ======================================================
      - name: Inject custom HW configurations
        run: |
          set -e

          if [ ! -d "custom_hwconf/$HW_TARGET" ]; then
            echo "ERROR: custom_hwconf/$HW_TARGET not found"
            exit 1
          fi

          echo "Injecting HW config: $HW_TARGET"
          cp custom_hwconf/$HW_TARGET/*.c bldc/hwconf/
          cp custom_hwconf/$HW_TARGET/*.h bldc/hwconf/

      # ======================================================
      # OFFICIAL VESC BUILD FLOW (UNCHANGED)
      # ======================================================
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential git wget libgl-dev libxcb-xinerama0

      - name: Install ARM SDK (official)
        run: |
          cd bldc
          make arm_sdk_install

      # ======================================================
      # BUILD
      # ======================================================
      - name: Build firmware
        run: |
          set -e
          cd bldc
          mkdir -p ../output

          build_one() {
            TARGET="$1"
            NAME="$2"

            echo "=============================="
            echo "Building $TARGET â†’ $NAME"
            echo "=============================="

            make fw_$TARGET

            OUT="${NAME}_${VERSION}"
            [ "$PREFIX_RFP" = "yes" ] && OUT="RFP_${OUT}"
            [ "$IS_BETA" = "yes" ] && OUT="${OUT}_BETA"

            mkdir -p ../output/$NAME
            cp build/$TARGET/$TARGET.bin ../output/$NAME/${OUT}.bin
          }

          if [ "$BUILD_MODE" = "single" ]; then
            build_one "$HW_TARGET" "$SINGLE_MODEL"

            if [ "$BUILD_NO_LIMITS" = "yes" ]; then
              build_one "${HW_TARGET}_no_limits" "${SINGLE_MODEL}_no_limits"
            fi
          else
            echo "BUILD_MODE=all not implemented yet"
            exit 1
          fi

      # ======================================================
      # ARCHIVE EXPORT (NON-DESTRUCTIVE)
      # ======================================================
      - name: Push firmware to archive
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: Foujiwara/rfp_fw_archive
          publish_branch: main
          publish_dir: ./output
          personal_token: ${{ secrets.ARCHIVE_TOKEN }}
          keep_files: true
